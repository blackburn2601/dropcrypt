{% extends 'base.html.twig' %}

{% block title %}New Message{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white shadow-md rounded-lg p-6">
            <h1 class="text-2xl font-bold mb-6">Create New Message</h1>

            <form id="messageForm" class="space-y-6">
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700">Message</label>
                    <div class="mt-1">
                        <textarea
                            id="message"
                            name="message"
                            rows="6"
                            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                            required
                        ></textarea>
                    </div>
                </div>

                <div>
                    <label for="expiration" class="block text-sm font-medium text-gray-700">Expiration Time</label>
                    <div class="mt-1">
                        <select
                            id="expiration"
                            name="expiration"
                            class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                        >
                            <option value="3600">1 hour</option>
                            <option value="21600">6 hours</option>
                            <option value="43200">12 hours</option>
                            <option value="86400">24 hours</option>
                            <option value="604800">7 days</option>
                        </select>
                    </div>
                </div>

                <div>
                    <button
                        type="submit"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    >
                        Create Message
                    </button>
                </div>
            </form>

            <div id="result" class="hidden mt-6">
                <div class="rounded-md bg-green-50 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Message Created Successfully</h3>
                            <div class="mt-2 text-sm text-green-700">
                                <p>Share this link with the recipient:</p>
                                <div class="mt-2">
                                    <input
                                        type="text"
                                        id="messageLink"
                                        readonly
                                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    >
                                </div>
                                <button
                                    onclick="copyToClipboard()"
                                    class="mt-2 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                >
                                    Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ asset('js/encryption.js') }}"></script>
<script>
document.getElementById('messageForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const message = document.getElementById('message').value;
    const expirationSeconds = parseInt(document.getElementById('expiration').value);

    try {
        // Generate encryption key
        const key = await MessageEncryption.generateKey();
        const keyString = await MessageEncryption.exportKey(key);

        // Encrypt the message
        const encryptedContent = await MessageEncryption.encrypt(message, key);

        // Hash the key for storage
        const keyHash = await MessageEncryption.hashKey(keyString);

        // Calculate expiration time
        const expiresAt = new Date(Date.now() + expirationSeconds * 1000).toISOString();

        // Send to backend
        const response = await fetch('/message/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: encryptedContent,
                keyHash: keyHash,
                expiresAt: expiresAt
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to create message');
        }

        // Show success message with link
        const messageLink = `${window.location.origin}/message/${data.accessToken}?key=${encodeURIComponent(keyString)}`;
        document.getElementById('messageLink').value = messageLink;
        document.getElementById('result').classList.remove('hidden');
        document.getElementById('messageForm').reset();

    } catch (error) {
        console.error('Error:', error);
        alert('Failed to create message: ' + error.message);
    }
});

function copyToClipboard() {
    const linkInput = document.getElementById('messageLink');
    linkInput.select();
    document.execCommand('copy');
    alert('Link copied to clipboard!');
}
</script>
{% endblock %} 